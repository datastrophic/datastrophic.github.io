<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="datastrophic">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://datastrophic.io//img/datastrophic-strip-1.png">
    <meta property="twitter:image" content="https://datastrophic.io//img/datastrophic-strip-1.png" />
    

    
    <meta name="title" content="Resource Allocation in Mesos: Dominant Resource Fairness" />
    <meta property="og:title" content="Resource Allocation in Mesos: Dominant Resource Fairness" />
    <meta property="twitter:title" content="Resource Allocation in Mesos: Dominant Resource Fairness" />
    

    
    <meta name="description" content="A blog about distributed systems, data platforms, and AI infrastructure">
    <meta property="og:description" content="A blog about distributed systems, data platforms, and AI infrastructure" />
    <meta property="twitter:description" content="A blog about distributed systems, data platforms, and AI infrastructure" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="Spark, Mesos, Kubernetes, Kubeflow, Istio, SMACK stack, Cassandra, Kafka">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Resource Allocation in Mesos: Dominant Resource Fairness</title>

    <link rel="canonical" href="/resource-allocation-in-mesos-dominant-resource-fairness-explained/">

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" type="text/css">

    
    <link rel="stylesheet" href="https://datastrophic.io/css/footer.css"><link rel="stylesheet" href="https://datastrophic.io/css/pager.css"><link rel="stylesheet" href="https://datastrophic.io/css/overrides.css">

    
    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
		            
                        <li><a href="/top/archive/">ARCHIVE</a></li>
                    
                        <li><a href="/top/about/">ABOUT</a></li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/datastrophic-strip-1.png');
        color: #3A4145;
    }
</style>
<header class="intro-header" style="background-image: url('/img/datastrophic-strip-1.png')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 ">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/mesos" title="mesos">
                            mesos
                        </a>
                        
                        <a class="tag" href="/tags/sheduling" title="sheduling">
                            sheduling
                        </a>
                        
                        <a class="tag" href="/tags/drf" title="DRF">
                            DRF
                        </a>
                        
                    </div>
                    <h1>Resource Allocation in Mesos: Dominant Resource Fairness</h1>
                    
                    <span class="meta">
                        
                            Posted on 
                            March 27, 2016
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>





<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <p>Apache Mesos provides a unique approach to cluster resource management called <strong>two-level scheduling</strong>: instead of storing information about available cluster resources in a centralized manner it operates with a notion of <strong>resource offers</strong> which slave nodes advertise to running <strong>frameworks</strong> via Mesos master, thus keeping the whole system architecture concise and scalable. Master&rsquo;s allocation module is responsible for making the decisions about which application should receive the next resource offer and it relies on Dominant Resource Fairness(DRF) algorithm for making these decisions. This post presents a set of experiments for different use cases using simple Mesos framework implementation to observe and analyze DRF behavior.</p>
<h2 id="architecture-recap">Architecture Recap</h2>
<p>Mesos <a href="http://mesos.apache.org/documentation/latest/architecture/">official documentation</a> provides a great overview of the architecture, so let&rsquo;s briefly recap the framework and resource offers part of it.</p>
<h3 id="frameworks">Frameworks</h3>
<p>Mesos frameworks consist of two main components: <em>Scheduler</em> and <em>Executor</em>.</p>
<p>The Scheduler is a single instance/process which negotiates with the Master and is responsible for handling resource offers, task submissions, tasks status updates, framework messages, and exceptional situations such as slave losses, disconnections, and various errors. Sometimes high availability is a requirement for schedulers, so some sort of leader election or specific logic is needed to avoid conflicts in task submissions.</p>
<p>The Executor is a process executed on Slave nodes that receive tasks from Scheduler and run them. Executor lifecycle is bound to Scheduler so when Scheduler finished its job it also shutdowns the executors (actually Mesos master performs this routine when framework terminates). If the Executor is a JVM process it usually has a thread pool for executing received tasks.</p>
<p>Tasks are serialized in <em>protobuf</em> and contain all the information about resources needed, executor to run on, some binary serialized payload (e.g. Spark tasks are serialized and transferred as a payload in Mesos tasks). Here&rsquo;s an example of how Task is created:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">def</span> buildTask<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Offer</span><span style="color:#ff79c6">,</span> cpus<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Double</span><span style="color:#ff79c6">,</span> memory<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">,</span> executorInfo<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ExecutorInfo</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
  <span style="color:#ff79c6">val</span> cpuResource <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Resource</span><span style="color:#ff79c6">.</span>newBuilder
                      <span style="color:#ff79c6">.</span>setType<span style="color:#ff79c6">(</span><span style="color:#50fa7b">SCALAR</span><span style="color:#ff79c6">)</span>
                      <span style="color:#ff79c6">.</span>setName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;cpus&#34;</span><span style="color:#ff79c6">)</span>
                      <span style="color:#ff79c6">.</span>setScalar<span style="color:#ff79c6">(</span><span style="color:#50fa7b">Scalar</span><span style="color:#ff79c6">.</span>newBuilder<span style="color:#ff79c6">.</span>setValue<span style="color:#ff79c6">(</span>cpus<span style="color:#ff79c6">))</span>
                      <span style="color:#ff79c6">.</span>setRole<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;*&#34;</span><span style="color:#ff79c6">)</span>
                      <span style="color:#ff79c6">.</span>build

  <span style="color:#ff79c6">val</span> memResource <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Resource</span><span style="color:#ff79c6">.</span>newBuilder
                      <span style="color:#ff79c6">.</span>setType<span style="color:#ff79c6">(</span><span style="color:#50fa7b">SCALAR</span><span style="color:#ff79c6">)</span>
                      <span style="color:#ff79c6">.</span>setName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;mem&#34;</span><span style="color:#ff79c6">)</span>
                      <span style="color:#ff79c6">.</span>setScalar<span style="color:#ff79c6">(</span><span style="color:#50fa7b">Scalar</span><span style="color:#ff79c6">.</span>newBuilder<span style="color:#ff79c6">.</span>setValue<span style="color:#ff79c6">(</span>memory<span style="color:#ff79c6">))</span>
                      <span style="color:#ff79c6">.</span>setRole<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;*&#34;</span><span style="color:#ff79c6">)</span>
                      <span style="color:#ff79c6">.</span>build

  <span style="color:#50fa7b">TaskInfo</span><span style="color:#ff79c6">.</span>newBuilder<span style="color:#ff79c6">()</span>
  <span style="color:#ff79c6">.</span>setSlaveId<span style="color:#ff79c6">(</span><span style="color:#50fa7b">SlaveID</span><span style="color:#ff79c6">.</span>newBuilder<span style="color:#ff79c6">().</span>setValue<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">.</span>getSlaveId<span style="color:#ff79c6">.</span>getValue<span style="color:#ff79c6">).</span>build<span style="color:#ff79c6">())</span>
  <span style="color:#ff79c6">.</span>setTaskId<span style="color:#ff79c6">(</span><span style="color:#50fa7b">TaskID</span><span style="color:#ff79c6">.</span>newBuilder<span style="color:#ff79c6">().</span>setValue<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;</span><span style="color:#f1fa8c">$uuid</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">))</span>
  <span style="color:#ff79c6">.</span>setExecutor<span style="color:#ff79c6">(</span>executorInfo<span style="color:#ff79c6">)</span>
  <span style="color:#ff79c6">.</span>setName<span style="color:#ff79c6">(</span><span style="color:#50fa7b">UUID</span><span style="color:#ff79c6">.</span>randomUUID<span style="color:#ff79c6">().</span>toString<span style="color:#ff79c6">)</span>
  <span style="color:#ff79c6">.</span>addResources<span style="color:#ff79c6">(</span>cpuResource<span style="color:#ff79c6">)</span>
  <span style="color:#ff79c6">.</span>addResources<span style="color:#ff79c6">(</span>memResource<span style="color:#ff79c6">)</span>
  <span style="color:#ff79c6">.</span>build<span style="color:#ff79c6">()</span>
<span style="color:#ff79c6">}</span>

<span style="color:#ff79c6">def</span> buildExecutorInfo<span style="color:#ff79c6">(</span>d<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SchedulerDriver</span><span style="color:#ff79c6">,</span> prefix<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ExecutorInfo</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
  <span style="color:#ff79c6">val</span> scriptPath <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">System</span><span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;executor.path&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;/throttle/throttle-executor.sh&#34;</span><span style="color:#ff79c6">)</span>

  <span style="color:#50fa7b">ExecutorInfo</span><span style="color:#ff79c6">.</span>newBuilder<span style="color:#ff79c6">()</span>
  <span style="color:#ff79c6">.</span>setCommand<span style="color:#ff79c6">(</span><span style="color:#50fa7b">CommandInfo</span><span style="color:#ff79c6">.</span>newBuilder<span style="color:#ff79c6">().</span>setValue<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/bin/sh &#34;</span><span style="color:#ff79c6">+</span>scriptPath<span style="color:#ff79c6">))</span>
  <span style="color:#ff79c6">.</span>setExecutorId<span style="color:#ff79c6">(</span><span style="color:#50fa7b">ExecutorID</span><span style="color:#ff79c6">.</span>newBuilder<span style="color:#ff79c6">().</span>setValue<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;</span><span style="color:#f1fa8c">${</span>prefix<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">_</span><span style="color:#f1fa8c">$uuid</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">))</span>
  <span style="color:#ff79c6">.</span>build<span style="color:#ff79c6">()</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>Sources are available at the <a href="https://github.com/datastrophic/mesos-workshop/tree/master/src/main/scala/io/datastrophic/mesos">accompanying gihub repo</a>.</p>
<h3 id="resource-offers">Resource Offers</h3>
<p>
  <img src="/blog/2016-03-27/mesos-resource-offers.jpeg" alt="">

</p>
<ol>
<li>Slave nodes periodically report to the Master free resources they can provide. This also happens when executor tasks complete minimizing delay</li>
<li><em>Allocation module</em> starts offering the resources to frameworks. A dominant resource fairness algorithm is used to define the order in which frameworks are offered the resource. The framework can either accept or decline the offer depending on its demand. In case of decline (e.g. insufficient resources of some type) the resources are offered to the next framework according to DRF.</li>
<li>If resources in the offer satisfy the framework&rsquo;s demand then it creates a list of <em>Tasks</em> and sends it back to Master. Master could respond with an error if tasks resources exceed the amount provided in the offer.</li>
<li>Master sends set of tasks to the <em>Executor</em> on the Slave (and launches the executor if it&rsquo;s not running)</li>
</ol>
<h3 id="dominant-resource-fairness-drf">Dominant Resource Fairness (DRF)</h3>
<p>The main problem that DRF solves is sharing of the resources of multiple types (but not only CPU) which hasn&rsquo;t been addressed before and caused insufficient resource distribution among applications with heterogeneous resource demands. To address this problem the notions of <em>dominant share</em> and <em>dominant resource</em> have been introduced.</p>
<p><em>Dominant resource</em> - a resource of a specific type (cpu, memory, disk, ports) which is most demanded by the given framework among other resources it needs. This resource is identified as a share of the total cluster resources of the same type.</p>
<p><em>Example 1</em>: given a cluster with the total amount of <em>10 CPUs</em> and <em>20GB RAM</em>, resource demands are: Framework A  <em>&lt; 4 CPU, 5 GB &gt;</em>, Framework B <em>&lt; 2 CPU, 8 GB &gt;</em>.
The same expressed as a share of total cluster resources: Framework A  <em>&lt; 40% CPU, 25% RAM &gt;</em>, Framework B <em>&lt; 20% CPU, 40% RAM &gt;</em>. So for Framework A CPU is a dominant resource, while for Framework B RAM is.</p>
<p>DRF computes the share of dominant resource allocated to a framework (<em>dominant share</em>) and tries to maximize the smallest dominant share in the system. During the next round of resource offers allocation module applies DRF to identify the dominant shares of the frameworks and offers the resources first to the one with the smallest dominant share, then to the second smallest one, and so on.</p>
<p><em>Example 2</em>: consider the cluster with total amount of <em>10 CPUs</em> and <em>20GB RAM</em>, resource demands are: Framework A  <em>&lt; 3 CPU, 2 GB &gt;</em>, Framework B <em>&lt; 1 CPU, 5 GB &gt;</em>. Same in percents: A_&lt; 33% CPU, 10% RAM &gt;_, B_&lt; 10% CPU, 25% RAM &gt;_. Steps:</p>
<pre tabindex="0"><code>1. (10cpu, 20gb) to A: A(3cpu, 2gb, 33%), B (0cpu, 0gb, 0%)
2. (&amp;nbsp;7cpu, 18gb) to B: A(4cpu, 5gb, 40%), B (1cpu, 5gb, 25%)
3. (&amp;nbsp;6cpu, 13gb) to B: A(4cpu, 5gb, 40%), B (2cpu, 10gb, 50%)
4. (&amp;nbsp;5cpu, &amp;nbsp;8gb) to A: A(6cpu, 4gb, 66%), B (2cpu, 10gb, 50%)
5. (&amp;nbsp;2cpu, &amp;nbsp;6gb) to B: A(6cpu, 4gb, 66%), B (3cpu, 15gb, 75%)
6. (&amp;nbsp;1cpu, &amp;nbsp;1gb) to A: A(6cpu, 4gb, 66%), B (3cpu, 15gb, 75%)
7. (&amp;nbsp;1cpu, &amp;nbsp;1gb) to B: A(6cpu, 4gb, 66%), B (3cpu, 15gb, 75%)
... and so on until the task of one of the frameworks is finished and resources are released.
</code></pre><p>Let&rsquo;s walk through the steps. The first resource offer goes to <strong>A</strong> (let&rsquo;s say it was executed first, so it receives the offer first). <strong>A</strong> accepts the offer and its dominant share becomes 33%, so the next offer goes to the framework with the smallest dominant share which is <strong>B</strong> (step 2). After accepting the offer dominant share of <strong>B</strong> becomes 25% which is less than the share of <strong>A</strong>, so it receives the next offer (step 3) and now its share is 50%. <strong>A</strong> becomes the framework with the smallest share and receives the next offer (step 4) and so on.</p>
<p>In the end, there is only 1cpu and 1gb RAM available, so that cluster CPU is utilized for 90% and RAM for 95% which is pretty good saturation.</p>
<p>Hopefully, the description was not very complicated, because the algorithm itself is very simple and sound. Please refer to the original paper <a href="https://www.cs.berkeley.edu/~alig/papers/drf.pdf">&ldquo;Dominant Resource Fairness: Fair Allocation of Multiple Resource Types&rdquo;</a> for more details.</p>
<p>There&rsquo;s not always that perfect cluster saturation in real life so the next part of the post will cover different use cases and how DRF addresses them. We&rsquo;re about to run several instances of simple Mesos Framework with different resource demands (configured at launch time) in parallel to observe DRF behavior and identify potential bottlenecks.</p>
<h2 id="example-framework">Example Framework</h2>
<p>For the purpose of observation of DRF behavior a simple Mesos framework is going to be used. The scheduler will submit one task per resource offer round, and the executor will emulate the processing by putting the task thread on sleep for a random amount of time. The main requirement of the framework is configurable task resource demands to properly set up different conditions for parallel execution with heterogeneous resource demands.</p>
<p>Resource offers handling in the Scheduler code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> resourceOffers<span style="color:#ff79c6">(</span>driver<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SchedulerDriver</span><span style="color:#ff79c6">,</span> offers<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">util.List</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Offer</span><span style="color:#ff79c6">])</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
  <span style="color:#ff79c6">for</span><span style="color:#ff79c6">(</span>offer <span style="color:#ff79c6">&lt;-</span> offers<span style="color:#ff79c6">){</span>
    stateLock<span style="color:#ff79c6">.</span>synchronized <span style="color:#ff79c6">{</span>
       logger<span style="color:#ff79c6">.</span>info<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;Received resource offer: cpus:</span><span style="color:#f1fa8c">${</span>getCpus<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">)</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> mem: </span><span style="color:#f1fa8c">${</span>getMemory<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">)</span><span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">)</span>

       <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>isOfferValid<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">)){</span>
          <span style="color:#ff79c6">val</span> executorInfo <span style="color:#ff79c6">=</span> executors<span style="color:#ff79c6">.</span>getOrElseUpdate<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">.</span>getSlaveId<span style="color:#ff79c6">.</span>getValue<span style="color:#ff79c6">,</span> buildExecutorInfo<span style="color:#ff79c6">(</span>driver<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;DRFDemoExecutor&#34;</span><span style="color:#ff79c6">))</span>

          <span style="color:#6272a4">//amount of tasks is calculated to fully use resources from the offer
</span><span style="color:#6272a4"></span>          <span style="color:#ff79c6">val</span> tasks <span style="color:#ff79c6">=</span> buildTasks<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">,</span> config<span style="color:#ff79c6">,</span> executorInfo<span style="color:#ff79c6">)</span>

          logger<span style="color:#ff79c6">.</span>info<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;Launching </span><span style="color:#f1fa8c">${</span>tasks<span style="color:#ff79c6">.</span>size<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> tasks on slave </span><span style="color:#f1fa8c">${</span>offer<span style="color:#ff79c6">.</span>getSlaveId<span style="color:#ff79c6">.</span>getValue<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">)</span>
          driver<span style="color:#ff79c6">.</span>launchTasks<span style="color:#ff79c6">(</span><span style="color:#50fa7b">List</span><span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">.</span>getId<span style="color:#ff79c6">),</span> tasks<span style="color:#ff79c6">)</span>
       <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
          logger<span style="color:#ff79c6">.</span>info<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;Offer provides insufficient resources. Declining.&#34;</span><span style="color:#ff79c6">)</span>
          driver<span style="color:#ff79c6">.</span>declineOffer<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">.</span>getId<span style="color:#ff79c6">)</span>
       <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
  <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>

<span style="color:#ff79c6">def</span> buildTasks<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Offer</span><span style="color:#ff79c6">,</span> config<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Config</span><span style="color:#ff79c6">,</span> executorInfo<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ExecutorInfo</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">List</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">TaskInfo</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
 <span style="color:#ff79c6">val</span> amount <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Math</span><span style="color:#ff79c6">.</span>min<span style="color:#ff79c6">(</span>getCpus<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">)/</span>config<span style="color:#ff79c6">.</span>cpus<span style="color:#ff79c6">,</span> getMemory<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">)/</span>config<span style="color:#ff79c6">.</span>mem<span style="color:#ff79c6">).</span>toInt
 <span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span> to amount<span style="color:#ff79c6">).</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">=&gt;</span> 
    buildTask<span style="color:#ff79c6">(</span>offer<span style="color:#ff79c6">,</span> config<span style="color:#ff79c6">.</span>cpus<span style="color:#ff79c6">,</span> config<span style="color:#ff79c6">.</span>mem<span style="color:#ff79c6">,</span> executorInfo<span style="color:#ff79c6">)</span>
 <span style="color:#ff79c6">).</span>toList
<span style="color:#ff79c6">}</span>
</code></pre></div><p>An excerpt from the Executor task handling method:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> launchTask<span style="color:#ff79c6">(</span>driver<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ExecutorDriver</span><span style="color:#ff79c6">,</span> task<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">TaskInfo</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
  threadPool<span style="color:#ff79c6">.</span>execute<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Runnable</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
     <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> run<span style="color:#ff79c6">()</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> taskStatus <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">TaskStatus</span><span style="color:#ff79c6">.</span>newBuilder<span style="color:#ff79c6">().</span>setTaskId<span style="color:#ff79c6">(</span>task<span style="color:#ff79c6">.</span>getTaskId<span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> taskId <span style="color:#ff79c6">=</span> task<span style="color:#ff79c6">.</span>getTaskId<span style="color:#ff79c6">.</span>getValue

        logger<span style="color:#ff79c6">.</span>info<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;Task </span><span style="color:#f1fa8c">$taskId</span><span style="color:#f1fa8c"> received by executor: </span><span style="color:#f1fa8c">${</span>task<span style="color:#ff79c6">.</span>getExecutor<span style="color:#ff79c6">.</span>getExecutorId<span style="color:#ff79c6">.</span>getValue<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">)</span>

        driver<span style="color:#ff79c6">.</span>sendStatusUpdate<span style="color:#ff79c6">(</span>
           taskStatus
           <span style="color:#ff79c6">.</span>setState<span style="color:#ff79c6">(</span><span style="color:#50fa7b">TaskState</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">TASK_RUNNING</span><span style="color:#ff79c6">)</span>
           <span style="color:#ff79c6">.</span>build<span style="color:#ff79c6">()</span>
        <span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> delay <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">20000</span> <span style="color:#ff79c6">+</span> <span style="color:#50fa7b">Random</span><span style="color:#ff79c6">.</span>nextInt<span style="color:#ff79c6">(</span><span style="color:#bd93f9">20000</span><span style="color:#ff79c6">)</span>
        logger<span style="color:#ff79c6">.</span>info<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;Running task for </span><span style="color:#f1fa8c">${</span>delay<span style="color:#ff79c6">/</span><span style="color:#bd93f9">1000</span>f<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> sec.&#34;</span><span style="color:#ff79c6">)</span>

        <span style="color:#50fa7b">Thread</span><span style="color:#ff79c6">.</span>sleep<span style="color:#ff79c6">(</span>delay<span style="color:#ff79c6">)</span>

        <span style="color:#ff79c6">val</span> msg <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">s&#34;Task </span><span style="color:#f1fa8c">$taskId</span><span style="color:#f1fa8c"> finished&#34;</span>
        logger<span style="color:#ff79c6">.</span>info<span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)</span>

        driver<span style="color:#ff79c6">.</span>sendStatusUpdate<span style="color:#ff79c6">(</span>
           taskStatus
           <span style="color:#ff79c6">.</span>setState<span style="color:#ff79c6">(</span><span style="color:#50fa7b">TaskState</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">TASK_FINISHED</span><span style="color:#ff79c6">)</span>
           <span style="color:#ff79c6">.</span>setData<span style="color:#ff79c6">(</span><span style="color:#50fa7b">ByteString</span><span style="color:#ff79c6">.</span>copyFrom<span style="color:#ff79c6">(</span>serialize<span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)))</span>
           <span style="color:#ff79c6">.</span>build<span style="color:#ff79c6">()</span>
        <span style="color:#ff79c6">)</span>
     <span style="color:#ff79c6">}</span>
  <span style="color:#ff79c6">})</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>And the framework&rsquo;s entrypoint looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">case</span> <span style="color:#ff79c6">class</span> <span style="color:#50fa7b">Config</span><span style="color:#ff79c6">(</span>
      mesosURL<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">,</span>
      name<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">,</span>
      cpus<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Double</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0.1</span><span style="color:#ff79c6">,</span>
      mem<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">512</span>
<span style="color:#ff79c6">)</span>
   
<span style="color:#ff79c6">...</span>

<span style="color:#ff79c6">def</span> run<span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Config</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">={</span>
  <span style="color:#ff79c6">val</span> framework <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">FrameworkInfo</span><span style="color:#ff79c6">.</span>newBuilder
                     <span style="color:#ff79c6">.</span>setName<span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">.</span>name<span style="color:#ff79c6">)</span>
                     <span style="color:#ff79c6">.</span>setUser<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">)</span>
                     <span style="color:#ff79c6">.</span>setRole<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;*&#34;</span><span style="color:#ff79c6">)</span>
                     <span style="color:#ff79c6">.</span>setCheckpoint<span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span>
                     <span style="color:#ff79c6">.</span>setFailoverTimeout<span style="color:#ff79c6">(</span><span style="color:#bd93f9">0.0d</span><span style="color:#ff79c6">)</span>
                     <span style="color:#ff79c6">.</span>build<span style="color:#ff79c6">()</span>

  <span style="color:#ff79c6">val</span> driver <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">MesosSchedulerDriver</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">DRFDemoScheduler</span><span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">),</span> framework<span style="color:#ff79c6">,</span> config<span style="color:#ff79c6">.</span>mesosURL<span style="color:#ff79c6">)</span>
  driver<span style="color:#ff79c6">.</span>run<span style="color:#ff79c6">()</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>Full source code available on <a href="https://github.com/datastrophic/mesos-workshop/tree/master/src/main/scala/io/datastrophic/mesos/drf">github</a>.</p>
<p>The config case class is created with <em>scopt</em> (scala options parser) and the framework invocation code looks as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">java -cp /throttle/throttle-framework.jar <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>-Dexecutor.path<span style="color:#ff79c6">=</span>/throttle/drf-executor.sh <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>io.datastrophic.mesos.drf.DRFDemoFramework <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>--mesos-master zk://zookeeper:2181/mesos <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>--framework-name <span style="color:#f1fa8c">&#39;Framework A&#39;</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>--task-cpus <span style="color:#bd93f9">2</span> <span style="color:#f1fa8c">\
</span><span style="color:#f1fa8c"></span>--task-memory <span style="color:#bd93f9">1000</span>
</code></pre></div><p>This allows running the same framework code with different task resource demands to easily setup experimental use cases.</p>
<h2 id="experiments">Experiments</h2>
<p>A small virtual cluster will be used for the experiment with a total capacity of 6 CPUs and 6.6 GB RAM. We&rsquo;re going to use small-sized dummy tasks (which simply sleep to emulate processing) so the total capacity is not big deal here. A dockerized environment is also available on <a href="https://github.com/datastrophic/mesos-workshop">github</a>.</p>
<h3 id="redistribution-of-resources-between-frameworks-with-same-demands">Redistribution of resources between frameworks with same demands</h3>
<p>Let&rsquo;s first look at how Mesos will redistribute resources when new frameworks with similar resource demands are added and removed from the cluster. We&rsquo;re going to use <em>&lt; 0.5 CPU, 512 RAM &gt;</em> (or <em>&lt; 8% CPU, 7.5% RAM &gt;</em>) as task resource demands and <code>20000 + Random.nextInt(20000) millis</code> as task duration to make tasks running for 20-40 seconds each because when tasks are too small the cluster will not be fully loaded (default resource offers round frequency is 5 seconds).</p>
<p>First <em>Framework A</em> will be launched as the only application running on the cluster. After a while we&rsquo;ll see this picture in Mesos UI:

  <img src="/blog/2016-03-27/frameworks-1.jpeg" alt="">

</p>
<p>Let&rsquo;s now launch competing <em>Framework B</em>. In most cases the behavior is as expected - equal sharing of resources:

  <img src="/blog/2016-03-27/frameworks-2.jpeg" alt="">

</p>
<p>But for short periods of time one can observe this picture (disregarding the framework):

  <img src="/blog/2016-03-27/frameworks-3.jpeg" alt="">

</p>
<p>This is a result of the transitional situation when both frameworks have been having equal dominant share (50/50) and when two of <em>Framework A&rsquo;s</em> tasks have finished close to each other in time (resulting in 4 running tasks). After that the first offer goes to A, it accepts and launches one task (now it&rsquo;s 5 running tasks). The next offer goes to B and it accepts it (having no tasks finished up to the moment, the total amount of tasks is 7). The next offer will go to <em>Framework A</em>. It&rsquo;s actually not an extraordinary situation though because these distortions are normal taking into account specifics of the framework implementations and how they work with resource offers.</p>
<p>Now <em>Framework C</em> is launched in the cluster:

  <img src="/blog/2016-03-27/frameworks-4.jpeg" alt="">

</p>
<p>For the reasons described above sometimes a different picture can be observed:

  <img src="/blog/2016-03-27/frameworks-5.jpeg" alt="">

</p>
<p>From this, we can conclude that if more frameworks are running in parallel then these discrepancies would be observed more often, but none of the frameworks will occupy the majority of the resources forever. DRF defines the priorities in which frameworks are offered the resources, but within a single round, none of the frameworks are offered resources twice. There exists Weighted DRF implementation which changes this behavior.</p>
<h3 id="redistribution-of-resources-between-frameworks-with-heterogeneous-resource-demands">Redistribution of resources between frameworks with heterogeneous resource demands</h3>
<p>Now <em>Framework A&rsquo;s</em> tasks will consume <em>&lt; 2 CPU, 1000 RAM &gt;</em> (or <em>&lt; 33% CPU, 15% RAM &gt;</em>) and <em>Framework B&rsquo;s</em> tasks will consume <em>&lt; 1 CPU, 2000 RAM &gt;</em> (or <em>&lt; 16% CPU, 30% RAM &gt;</em>).</p>
<p>Let&rsquo;s see how it works:

  <img src="/blog/2016-03-27/frameworks-6.jpeg" alt="">

</p>
<p>Looks awesome, but here&rsquo;s a trick in resource demands: frameworks together completely saturate the cluster and their dominant resources are not in the conflict. Two tasks of <em>Framework A</em> use ~60% of cluster CPU while two tasks of <em>Framework B</em> use ~67% of memory. But let&rsquo;s increase <em>Framework B&rsquo;s</em> memory demands up to 36% (2500MB), so to run two tasks it will need &gt;72% of the max share and more resources in the offer. Most of the time we&rsquo;ll be observing this picture:

  <img src="/blog/2016-03-27/frameworks-7.jpeg" alt="">

</p>
<p>The picture could change when both tasks of <em>Framework A</em> are finished in between resource offer rounds and all freed resources are offered to <em>Framework B</em> which will launch two of its tasks. After that there are enough resources for launching only one task of <em>Framework A</em> :

  <img src="/blog/2016-03-27/frameworks-8.jpeg" alt="">

</p>
<p>The conclusion is that running multiple small tasks is better than launching large ones in terms of time spent waiting for enough resources to be freed by other frameworks.</p>
<h2 id="discussion">Discussion</h2>
<p>After a number of simulations with a different number of frameworks with different dominant resources the observations described above still hold. Corner cases still appear but within different time frames, and resource allocations converge to a fair distribution of resources.</p>
<p>One important thing to note is that one resource offer represents the amount of resources available on one slave node. This means that if someone wants to execute a task that needs N cpus and M memory there should exist a physical node in the cluster which has this capacity.</p>
<p>Mesos enforces incremental task execution to run the whole job (<em>fine-grained mode</em>), but if some sort of gang scheduling is needed then the framework could implement a <em>coarse-grained</em> approach (like Spark does) to run its executors with maximum available resources and schedule the job by means of the framework. Another important thing to mention is that frameworks don&rsquo;t have information about the total amount of cluster resources so it&rsquo;s hardly possible to allocate all the resources at once.</p>
<h2 id="drf-properties">DRF Properties</h2>
<p>The Dominant Resource Fairness algorithm satisfies several important properties which are worth mentioning to have a full picture. Cites are from the original paper <a href="https://www.cs.berkeley.edu/~alig/papers/drf.pdf">&ldquo;Dominant Resource Fairness: Fair Allocation of Multiple Resource Types&rdquo;</a>:</p>
<ul>
<li><em>Sharing incentive</em>: Each user should be better off sharing the cluster, than exclusively using her own partition of the cluster. Consider a cluster with identical nodes and <em>n</em> users. Then a user should not be able to allocate more tasks in a cluster partition consisting of <em>1/n</em> of all resources.</li>
<li><em>Strategy-proofness</em>: Users should not be able to benefit by lying about their resource demands. This provides incentive compatibility, as a user cannot improve her allocation by lying.</li>
<li><em>Envy-freeness</em>: A user should not prefer the allocation of another user. This property embodies the notion of fairness.</li>
<li><em>Pareto efficiency</em>: It should not be possible to increase the allocation of a user without decreasing the allocation of at least another user. This property is important as it leads to maximizing system utilization subject to satisfying the other properties.</li>
<li><em>Single resource</em>  fairness: For a single resource, the solution should reduce to max-min fairness.</li>
<li><em>Bottleneck fairness</em>: If there is one resource that is percent-wise demanded most of by every user, then the solution should reduce to max-min fairness for that resource.</li>
<li><em>Population monotonicity</em>: When a user leaves the system and relinquishes her resources, none of the allocations of the remaining users should decrease.</li>
<li><em>Resource monotonicity</em>: If more resources are added to the system, none of the allocations of the existing users should decrease.</li>
</ul>
<p>Rephrasing a <em>sharing incentive</em> point: users are offered to share the whole cluster resources instead of exclusively owning their own partition. While in both cases the user has guaranteed minimum allocation of <em>1/n</em> of cluster resources (given that there&rsquo;re <em>n</em> users) in case of partition allocation user will not be able to allocate more tasks than <em>1/n</em> while with DRF it&rsquo;s possible to allocate more tasks using resources released by other frameworks.</p>
<h2 id="where-to-go-from-here">Where to go from here</h2>
<ul>
<li>The original Mesos paper: <a href="https://www.cs.berkeley.edu/~alig/papers/drf.pdf">&ldquo;Dominant Resource Fairness: Fair Allocation of Multiple Resource Types&rdquo;</a></li>
<li>Video of the DRF talk at <a href="https://www.usenix.org/conference/nsdi11/dominant-resource-fairness-fair-allocation-multiple-resource-types">USENIX Symposium on Networked Systems Design and Implementation</a></li>
<li>Paper: <a href="https://www.cs.berkeley.edu/~alig/papers/mesos.pdf">Mesos: A Platform for Fine-Grained Resource Sharing in the Data Center</a></li>
<li>Paper on Omega scheduler describing different from two-level scheduling approaches: <a href="http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/41684.pdf">Omega: flexible, scalable schedulers for large compute clusters</a></li>
<li>Project code and dockerized environment to work with at <a href="https://github.com/datastrophic/mesos-workshop">github</a></li>
</ul>

                
                <nav class="pagination" role="navigation">
                    
                        <a class="older-posts" href="/spark-jobserver-from-spark-standalone-to-mesos-marathon-and-docker-part-i/">Next Post &rarr;</a>
                    
                    
                    
                        <a class="newer-posts" href="/core-concepts-architecture-and-internals-of-apache-spark/">&larr; Previous Post</a>
                    
                </nav>                
            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CONTENTS</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/akka" title="akka">
                            akka
                        </a>
                        
                        
                        
                        <a href="/tags/cassandra" title="cassandra">
                            cassandra
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/mesos" title="mesos">
                            mesos
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/sheduling" title="sheduling">
                            sheduling
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/spark" title="spark">
                            spark
                        </a>
                        
                        
                    </div>
                </section>
                
            </div>
        </div>
    </div>
</article>



<footer class="site-footer clearfix">
    <section class="copyright"><a href="">datastrophic</a> &copy; 2021</section>
    <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a></section>
</footer>


<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>




<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>


</body>
</html>
