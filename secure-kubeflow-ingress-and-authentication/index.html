<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#FFFFFF"><title>Secure Kubeflow Ingress and Authentication with Istio External Auth, Dex, and OAuth2 Proxy &#183; datastrophic</title><meta name=title content="Secure Kubeflow Ingress and Authentication with Istio External Auth, Dex, and OAuth2 Proxy &#183; datastrophic"><script type=text/javascript src=https://datastrophic.io/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="></script><link type=text/css rel=stylesheet href=https://datastrophic.io/css/main.bundle.min.8ddd6ca5d23ba630c6633e1e51f0ac292850c4d2af977565a9c52e2a3179e5c9.css integrity="sha256-jd1spdI7pjDGYz4eUfCsKShQxNKvl3VlqcUuKjF55ck="><script defer type=text/javascript id=script-bundle src=https://datastrophic.io/js/main.bundle.min.d4b727caf411cb5c3b421d0d427ed1e3daeafe0d04840327efad4978430edb8c.js integrity="sha256-1LcnyvQRy1w7Qh0NQn7R49rq/g0EhAMn761JeEMO24w=" data-copy=Copy data-copied=Copied></script><meta name=description content="
      
        Publicly exposed insecure service endpoints on Kubernetes produce a major risk of malicious workloads being deployed on your clusters. We’ve seen reports of the Kubernetes Dashboard, the Kubeflow Central Dashboard, and the Kubeflow Pipelines all were compromised when publicly exposed to the Internet. Combined with wide RBAC permissions, a publicly exposed software with workload scheduling capabilities opens your clusters for malicious deployments to anybody knowing the endpoint URL. This blog post focuses on building a secure ingress and authentication stack on Kubernetes with Istio targeting Kubeflow installations.
      
    "><link rel=canonical href=https://datastrophic.io/secure-kubeflow-ingress-and-authentication/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://datastrophic.io/secure-kubeflow-ingress-and-authentication/"><meta property="og:site_name" content="datastrophic"><meta property="og:title" content="Secure Kubeflow Ingress and Authentication with Istio External Auth, Dex, and OAuth2 Proxy"><meta property="og:description" content="Publicly exposed insecure service endpoints on Kubernetes produce a major risk of malicious workloads being deployed on your clusters. We’ve seen reports of the Kubernetes Dashboard, the Kubeflow Central Dashboard, and the Kubeflow Pipelines all were compromised when publicly exposed to the Internet. Combined with wide RBAC permissions, a publicly exposed software with workload scheduling capabilities opens your clusters for malicious deployments to anybody knowing the endpoint URL. This blog post focuses on building a secure ingress and authentication stack on Kubernetes with Istio targeting Kubeflow installations."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-16T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-16T00:00:00+00:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Istio"><meta property="article:tag" content="Kubeflow"><meta name=twitter:card content="summary"><meta name=twitter:title content="Secure Kubeflow Ingress and Authentication with Istio External Auth, Dex, and OAuth2 Proxy"><meta name=twitter:description content="Publicly exposed insecure service endpoints on Kubernetes produce a major risk of malicious workloads being deployed on your clusters. We’ve seen reports of the Kubernetes Dashboard, the Kubeflow Central Dashboard, and the Kubeflow Pipelines all were compromised when publicly exposed to the Internet. Combined with wide RBAC permissions, a publicly exposed software with workload scheduling capabilities opens your clusters for malicious deployments to anybody knowing the endpoint URL. This blog post focuses on building a secure ingress and authentication stack on Kubernetes with Istio targeting Kubeflow installations."><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"Secure Kubeflow Ingress and Authentication with Istio External Auth, Dex, and OAuth2 Proxy","headline":"Secure Kubeflow Ingress and Authentication with Istio External Auth, Dex, and OAuth2 Proxy","abstract":"Publicly exposed insecure service endpoints on Kubernetes produce a major risk of malicious workloads being deployed on your clusters. We’ve seen reports of the Kubernetes Dashboard, the Kubeflow Central Dashboard, and the Kubeflow Pipelines all were compromised when publicly exposed to the Internet. Combined with wide RBAC permissions, a publicly exposed software with workload scheduling capabilities opens your clusters for malicious deployments to anybody knowing the endpoint URL. This blog post focuses on building a secure ingress and authentication stack on Kubernetes with Istio targeting Kubeflow installations.","inLanguage":"en","url":"https:\/\/datastrophic.io\/secure-kubeflow-ingress-and-authentication\/","author":{"@type":"Person","name":"Anton Kirillov"},"copyrightYear":"2021","dateCreated":"2021-12-16T00:00:00\u002b00:00","datePublished":"2021-12-16T00:00:00\u002b00:00","dateModified":"2021-12-16T00:00:00\u002b00:00","keywords":["kubernetes","istio","kubeflow"],"mainEntityOfPage":"true","wordCount":"3358"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://datastrophic.io/","name":"","position":1},{"@type":"ListItem","item":"https://datastrophic.io/posts/","name":"","position":2},{"@type":"ListItem","name":"Secure Kubeflow Ingress and Authentication With Istio External Auth, Dex, and Oauth2 Proxy","position":3}]}</script><meta name=author content="Anton Kirillov"><link href=https://www.linkedin.com/in/datastrophic/ rel=me><link href=https://github.com/datastrophic rel=me><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z9WG27GT0G"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z9WG27GT0G")}</script></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden"><nav class="flex items-start justify-between sm:items-center"><div class="z-40 flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>datastrophic</a></div><label id=menu-button for=menu-controller class="block sm:hidden"><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="invisible fixed inset-0 z-30 m-auto h-full w-full cursor-default overflow-auto bg-neutral-100/50 opacity-0 backdrop-blur-sm transition-opacity dark:bg-neutral-900/50"><ul class="mx-auto flex w-full max-w-7xl list-none flex-col overflow-visible px-6 py-6 text-end sm:px-14 sm:py-10 sm:pt-10 md:px-24 lg:px-32"><li class=mb-1><span class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class="group mb-1"><a href=/posts/ title onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">archive</span></a></li><li class="group mb-1"><a href=/about/ title onclick=close_menu()><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">about</span></a></li></ul></div></label><ul class="hidden list-none flex-row text-end sm:flex"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/posts/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">archive</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0"><a href=/about/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">about</span></a></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Secure Kubeflow Ingress and Authentication with Istio External Auth, Dex, and OAuth2 Proxy</h1><div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-12-16 00:00:00 +0000 UTC">16 December 2021</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">16 mins</span></div><div class="my-1 flex flex-wrap text-xs leading-relaxed text-neutral-500 dark:text-neutral-400"><a href=https://datastrophic.io/tags/kubernetes/ class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">Kubernetes</a>
<a href=https://datastrophic.io/tags/istio/ class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">Istio</a>
<a href=https://datastrophic.io/tags/kubeflow/ class="mx-1 my-1 rounded-md border border-neutral-200 px-1 py-[1px] hover:border-primary-300 hover:text-primary-700 dark:border-neutral-600 dark:hover:border-primary-600 dark:hover:text-primary-400">Kubeflow</a></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="min-h-0 min-w-0 max-w-prose grow"><p>Publicly exposed insecure service endpoints on Kubernetes produce a major risk of malicious workloads being
deployed on your clusters. We&rsquo;ve seen reports of the
<a href=https://azure.microsoft.com/en-us/blog/detect-largescale-cryptocurrency-mining-attack-against-kubernetes-clusters/ target=_blank rel=noreferrer>Kubernetes Dashboard</a>,
the <a href=https://www.microsoft.com/security/blog/2020/06/10/misconfigured-kubeflow-workloads-are-a-security-risk/ target=_blank rel=noreferrer>Kubeflow Central Dashboard</a>,
and the <a href=https://techcommunity.microsoft.com/t5/microsoft-defender-for-cloud/new-large-scale-campaign-targets-kubeflow/ba-p/2425750 target=_blank rel=noreferrer>Kubeflow Pipelines</a>
all were compromised when publicly exposed to the Internet. Combined with wide RBAC permissions,
a publicly exposed software with workload scheduling capabilities opens your clusters for malicious
deployments to anybody knowing the endpoint URL.</p><p>This blog post focuses on building a secure ingress and authentication stack on Kubernetes with Istio targeting Kubeflow installations. The post covers the existing approach used in the open-source Kubeflow distribution and its shortcomings and provides an alternative solution that uses the latest security features from Istio and an alternative authentication proxy.</p><h2 id=kubeflow-ingress-and-authentication class="relative group">Kubeflow Ingress and Authentication <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#kubeflow-ingress-and-authentication aria-label=Anchor>#</a></span></h2><h3 id=overview class="relative group">Overview <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#overview aria-label=Anchor>#</a></span></h3><p>The main open source Kubeflow releases reside in the <a href=https://github.com/kubeflow/manifests target=_blank rel=noreferrer>kubeflow/manifests</a> repository that aims at easing the installation and providing a tested starting point for derived distributions (<a href=https://github.com/kubeflow/manifests#installation target=_blank rel=noreferrer>link</a>). The repository provides manifests for both the Kubeflow components and the dependencies required for the ingress and security stack such as Istio, Dex, and OIDC AuthService. Kubeflow relies on Istio for ingress, traffic routing, and authorization policies for multi-tenancy. Let&rsquo;s consider the high-level ingress architecture and resource placement shown in the diagram below:</p><p><figure><img src=./kubeflow-default-ingress.png alt="Default Kubeflow Ingress" class="mx-auto my-0 rounded-md"></figure></p><p>Kubeflow installation configures the default shared Istio Ingress Gateway running in the <code>istio-system</code> namespace using <code>Gateway</code> and <code>VirtualService</code> custom resources for routing and the <code>EnvoyFilter</code> for the request authorization. The <code>EnvoyFilter</code> forwards the incoming traffic to the <a href=https://github.com/arrikto/oidc-authservice target=_blank rel=noreferrer>OIDC AuthService</a> that validates the authorization cookie and can either allow the request to proceed, deny it due to invalid authorization, or trigger an authentication workflow with an external system such as <a href=https://dexidp.io/ target=_blank rel=noreferrer>Dex</a>.</p><h3 id=shortcomings-of-the-existing-approach class="relative group">Shortcomings of the existing approach <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#shortcomings-of-the-existing-approach aria-label=Anchor>#</a></span></h3><h4 id=tight-coupling-of-the-ingress-stack-with-kubeflow class="relative group">Tight coupling of the ingress stack with Kubeflow <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#tight-coupling-of-the-ingress-stack-with-kubeflow aria-label=Anchor>#</a></span></h4><p>Kubeflow relies on several external systems for its security-related features: cert-manager, Istio, Dex, and OIDC AuthService. The convenience of <a href=https://github.com/kubeflow/manifests target=_blank rel=noreferrer>kubeflow/manifests</a> providing all of these dependencies in one place brings additional coupling when the ingress resources are deployed. For example, <code>Gateway</code> and <code>EnvoyFilter</code> resources are deployed in the <code>kubeflow</code> namespace but at the same time, they configure the default Istio Ingress Gateway running in the <code>istio-system</code> namespace that can be used by other services in the cluster. When the <code>Gateway</code> is uninstalled, the configuration for the shared ingress gateway is dropped with it too.</p><p>When Kubeflow installation becomes yet another cluster citizen, it should be able to seamlessly integrate with the existing platform-side components without producing alternative authentication paths or overwriting existing routes in the default Istio Gateway.</p><h4 id=use-of-the-insecure-gateway-and-endpoints class="relative group">Use of the insecure Gateway and endpoints <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#use-of-the-insecure-gateway-and-endpoints aria-label=Anchor>#</a></span></h4><p>As of version 1.4, the Kubeflow manifests use HTTP Gateway without any TLS in place. TLS is an essential security measure nowadays and, surprisingly, publicly exposed endpoints serve plaintext HTTP disregarding the environment they are deployed into (e.g. on-premise or air-gapped clusters).</p><p>The Dex installation coming with Kubeflow is also exposed via the same <code>Gateway</code> and its clients (such as OIDC AuthService) don&rsquo;t have a way to verify the identity of the service. Although the OIDC AuthService supports the functionality for verifying the OIDC provider endpoint by providing a CA bundle it is not utilized.</p><h4 id=envoyfilter-maintainability-issue class="relative group">EnvoyFilter maintainability issue <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#envoyfilter-maintainability-issue aria-label=Anchor>#</a></span></h4><p>Envoy&rsquo;s <code>ext_authz</code> filter configured with the <code>EnvoyFilter</code> CRD used for forwarding requests to the OIDC AuthService is a pretty low-level primitive which could be difficult to maintain and troubleshoot. The major pain points are described in the Istio <a href="https://docs.google.com/document/d/1V4mCQCw7mlGp0zSQQXYoBdbKMDnkPOjeyUb85U07iSI/edit#heading=h.kin6s6rv2n0i" target=_blank rel=noreferrer>Better External Authorization</a> design doc. Here are a few excerpts that are relevant for Kubeflow:</p><ul><li>No support for the conditional triggering of the external authorization flow. Some paths don&rsquo;t need it (e.g. user-facing authentication endpoint itself).</li><li>As <code>ext_authz</code> depends on the Envoy API, the <code>EnvoyFilter</code> can start failing after a small change in the upstream. Sometimes they are <strong>failing silently</strong>.</li><li>Overall difficult maintenance and troubleshooting of the <code>EnvoyFilter</code> CRD.</li></ul><h4 id=oidc-authservice-maintenance-and-community-support class="relative group">OIDC AuthService maintenance and community support <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#oidc-authservice-maintenance-and-community-support aria-label=Anchor>#</a></span></h4><p>OIDC AuthService is a great solution for the auth proxy, however, the <a href=https://github.com/arrikto/oidc-authservice/graphs/commit-activity target=_blank rel=noreferrer>project&rsquo;s GitHub</a> doesn&rsquo;t look very active and it is not clear what amount of maintenance it receives. It also doesn&rsquo;t have any releases in its GitHub repository so the whole release process is opaque. The single source of truth seems to be the Docker image tag (commit hash) used in manifests.
Another concern with OIDC AuthService is that it seems to be tailored for Kubeflow needs only and is not used in any other setup. This could make it potentially vulnerable for non-Kubeflow specific use-cases that haven&rsquo;t been tested but might happen in production deployments.</p><h2 id=proposed-solution-for-secure-ingress-and-external-authentication class="relative group">Proposed solution for Secure Ingress and External Authentication <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#proposed-solution-for-secure-ingress-and-external-authentication aria-label=Anchor>#</a></span></h2><h3 id=overview-1 class="relative group">Overview <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#overview-1 aria-label=Anchor>#</a></span></h3><h4 id=decoupling-the-ingress-stack-from-kubeflow class="relative group">Decoupling the ingress stack from Kubeflow <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#decoupling-the-ingress-stack-from-kubeflow aria-label=Anchor>#</a></span></h4><p>The ingress and authentication stack should be treated as a cluster-scoped entity so that all cluster tenants (services and applications) can integrate with it and benefit from the pre-configured security and authentication flow. That way, Kubeflow becomes another consumer of the authentication stack and doesn&rsquo;t deal with the installation of the security primitives.</p><p>Independent installation and management of the ingress and authentication stack allows using the latest stable software versions and the recommended installation methods such as official Helm Charts instead of the back-ported manifests</p><h4 id=securing-the-endpoints class="relative group">Securing the Endpoints <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#securing-the-endpoints aria-label=Anchor>#</a></span></h4><p>Istio natively supports TLS at the <code>Gateway</code> and with the Cert-manager available on the cluster, it is possible to create a CA <code>ClusterIssuer</code> and provide a certificate to the <code>Gateway</code>. The CA <code>ClusterIssuer</code> can then also be used to mount a CA file to the authentication proxy for validating the Dex identity. Additionally, it is beneficial to enable mutual TLS for all user-facing and authentication-related components when possible (not all Kubeflow components work well when Istio sidecars are injected).</p><h4 id=using-istio-external-auth class="relative group">Using Istio External Auth <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#using-istio-external-auth aria-label=Anchor>#</a></span></h4><p>Starting from version 1.9 Istio supports <a href=https://istio.io/latest/docs/tasks/security/authorization/authz-custom/ target=_blank rel=noreferrer>external authorization</a> and allows configuring <code>AuthorizationPolicies</code> to delegate authorization to external systems. This functionality came to replace the low-level <code>EnvoyFilter</code> configuration API and was driven by the shortcomings of the <code>ext_authz</code> approach. There&rsquo;s a great blog post from Istio describing it: <a href=https://istio.io/latest/blog/2021/better-external-authz/ target=_blank rel=noreferrer>Better External Authorization</a>.</p><h4 id=migrating-to-oauth2-proxy-with-dex class="relative group">Migrating to OAuth2 Proxy with Dex <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#migrating-to-oauth2-proxy-with-dex aria-label=Anchor>#</a></span></h4><p>Dex is a popular choice for Kubernetes authentication used in production, however, an alternative solution will be used instead of OIDC AuthService. <a href=https://oauth2-proxy.github.io/oauth2-proxy/ target=_blank rel=noreferrer>OAuth2 Proxy</a> looks like a better alternative based on its functionality, <a href=https://github.com/oauth2-proxy/oauth2-proxy/graphs/commit-activity target=_blank rel=noreferrer>GitHub activity</a>, availability of the versioned releases, quality <a href=https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/overview target=_blank rel=noreferrer>documentation</a>, and the official Helm Chart for the installation.</p><h3 id=deployment-layout class="relative group">Deployment layout <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#deployment-layout aria-label=Anchor>#</a></span></h3><p>Let&rsquo;s consider the following deployment and ingress diagram for a dedicated Kubeflow cluster:</p><p><figure><img src=./kubeflow-target-ingress.png alt="Kubeflow Target Ingress" class="mx-auto my-0 rounded-md"></figure></p><p>There are several differences and improvements compared to the default Kubeflow installation:</p><ul><li>The proposed layout follows the idea of the centralized security and authentication stack independent from Kubeflow. The consumers of the stack can be added to or removed from a cluster without affecting other consumers. This setup is beneficial for installations where Kubeflow is yet another tenant sharing the cluster with other business applications.</li><li>The Secure Istio Gateway with TLS termination running in a dedicated ingress namespace as <a href=https://istio.io/latest/docs/setup/additional-setup/gateway/#deploying-a-gateway target=_blank rel=noreferrer>the security best practice doesn&rsquo;t recommend installing it in the Istio namespace</a> and uses a <code>Certificate</code> issued by the cert-manager.</li><li>Istio External Authorization is configured for the Ingress Gateway by an <code>AuthorizationPolicy</code> and verifies the incoming requests with Dex via OAuth2 Proxy. Dex and OAuth2 Proxy have <code>VirtualService</code> routes defined for them and will be using the Ingress Gateway address for the authentication endpoints and callbacks so that both internal and external users and systems have the access to them. This setup is useful when the OIDC provider is external to the cluster or running at a different address.</li><li>Security-related components deployed in a dedicated namespace and can have additional policies applied to them in a narrow scope. This layout is also beneficial if other services running on the cluster and which require authentication but are not related to Kubeflow, for example, user-facing Grafana and Prometheus.</li></ul><h2 id=implementing-secure-ingress-and-authentication class="relative group">Implementing Secure Ingress and Authentication <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#implementing-secure-ingress-and-authentication aria-label=Anchor>#</a></span></h2><p>This section contains practical steps and code snippets for installing and configuring the secure ingress and authentication stack. It mostly focuses on the generic part that applies to any cluster that requires setting up the security, and at the end provides a sub-section with a basic Kubeflow installation to verify the setup.</p><p>The main topics covered in this section include setting up required security dependencies with Helm, creating a CA <code>ClusterIssuer</code> with a self-signed CA, configuring secure ingress, configuring Istio External Authorization, installing and configuring OAuth2 Proxy and Dex for authentication, and installing a minimalistic Kubeflow distribution.</p><blockquote><p><strong>NOTE:</strong> The following tutorial was created on an on-premises deployment with MetalLB assigning addresses for <code>Services</code> with the <code>LoadBalancer</code> type. The exposed ingress endpoints with the network IPs assigned will be referenced by the IP address instead of FQDN for simplicity and to avoid setting up and configuring a DNS Server.</p></blockquote><h3 id=securing-the-ingress-gateway class="relative group">Securing the Ingress Gateway <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#securing-the-ingress-gateway aria-label=Anchor>#</a></span></h3><p>The first step in configuring secure ingress on a cluster is to get the required software and configure it to serve the traffic. Disregarding whether it is required solely for Kubeflow or generic cluster security, this part of the setup will be the same.</p><h4 id=installing-cert-manager-istio-and-ingress-gateway class="relative group">Installing Cert-manager, Istio, and Ingress Gateway <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#installing-cert-manager-istio-and-ingress-gateway aria-label=Anchor>#</a></span></h4><p>Installing cert-manager:</p><pre tabindex=0><code>helm repo add jetstack https://charts.jetstack.io
helm repo update  

helm install cert-manager jetstack/cert-manager \
  --version v1.6.1 \
  --set installCRDs=true \
  --namespace cert-manager \
  --create-namespace
</code></pre><p>Istio ships independent Helm Charts for CRDs, Istiod, and the Ingress Gateway. The source code for the Charts can be found <a href=https://github.com/istio/istio/tree/master/manifests/charts target=_blank rel=noreferrer>here</a>. At this point, only CRDs and Istiod will be needed:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm repo add istio https://istio-release.storage.googleapis.com/charts
</span></span><span class=line><span class=cl>helm repo update  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>helm install istio-base istio/base <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --version 1.12.1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace istio-system <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --create-namespace  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>helm install istiod istio/istiod <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --version 1.12.1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace istio-system <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --wait
</span></span></code></pre></div><p>Create the Istio Ingress Gateway in a dedicated <code>ingress</code> namespace:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm install istio-ingressgateway istio/gateway <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --version 1.12.1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace ingress <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --create-namespace
</span></span><span class=line><span class=cl>  --wait
</span></span></code></pre></div><p>The Ingress Gateway from this Chart creates an Envoy Proxy <code>Deployment</code> and a <code>Service</code> with the <code>LoadBalancer</code> type. At this point there are no routes defined and all requests to the <code>Service</code> will be dropped (you can check it with <code>curl</code>). Verify the <code>Service</code> has the external address assigned. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl get svc istio-ingressgateway -n ingress
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP      PORT<span class=o>(</span>S<span class=o>)</span>                                      AGE
</span></span><span class=line><span class=cl>istio-ingressgateway   LoadBalancer   10.99.197.129   192.168.50.150   15021:31107/TCP,80:32027/TCP,443:31920/TCP   11m
</span></span></code></pre></div><h4 id=creating-ca-clusterissuer-for-signing-certificates class="relative group">Creating CA <code>ClusterIssuer</code> for signing certificates <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#creating-ca-clusterissuer-for-signing-certificates aria-label=Anchor>#</a></span></h4><p>For simplicity, we will be using the <code>ClusterIssuer</code> to ease the certificate issuance and use the same CA for signing all certificates. For that, it is required to create a CA key and certificate to provide to the Cert-manager <code>ClusterIssuer</code>. We will use <a href=https://github.com/cloudflare/cfssl target=_blank rel=noreferrer>cfssl</a> but any other appropriate<br>tool can be used instead.</p><p>Create a CSR (Certificate Signing Request) file in json format. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; csr.json  
</span></span></span><span class=line><span class=cl><span class=s>{  
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;Datastrophic&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>	&#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>	  &#34;C&#34;: &#34;US&#34;,
</span></span></span><span class=line><span class=cl><span class=s>	  &#34;L&#34;:
</span></span></span><span class=line><span class=cl><span class=s>	  &#34;San Francisco&#34;,
</span></span></span><span class=line><span class=cl><span class=s>	  &#34;O&#34;: &#34;Datastrophic&#34;,
</span></span></span><span class=line><span class=cl><span class=s>	  &#34;ST&#34;: &#34;California&#34;
</span></span></span><span class=line><span class=cl><span class=s>	}
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>Then, run <code>cfssl</code> to generate the initial CA key and certificate:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cfssl gencert -initca csr.json <span class=p>|</span> cfssljson -bare ca
</span></span></code></pre></div><p>Create a Kubernetes Secret to hold the key and certificate, as per <a href=https://cert-manager.io/docs/configuration/ca/#deployment target=_blank rel=noreferrer>cert-manager docs</a>. The secret for the <code>ClusterIssuer</code> should be created in the <a href=https://cert-manager.io/docs/configuration/ca/#deployment target=_blank rel=noreferrer>&ldquo;cluster resource namespace&rdquo;</a> which defaults to <code>cert-manager</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create secret tls ca-secret <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace cert-manager <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cert<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --key<span class=o>=</span>ca-key.pem
</span></span></code></pre></div><p>Create a CA <code>ClusterIssuer</code> referencing the previously created <code>Secret</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: cert-manager.io/v1  
</span></span></span><span class=line><span class=cl><span class=s>kind: ClusterIssuer  
</span></span></span><span class=line><span class=cl><span class=s>metadata:  
</span></span></span><span class=line><span class=cl><span class=s>  name: ca-issuer
</span></span></span><span class=line><span class=cl><span class=s>spec:  
</span></span></span><span class=line><span class=cl><span class=s>  ca:
</span></span></span><span class=line><span class=cl><span class=s>    secretName: ca-secret
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>Verify the <code>ClusterIssuer</code> is ready:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl get clusterissuer -o wide
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME      READY   STATUS                AGE
</span></span><span class=line><span class=cl>ca-issuer True    Signing CA verified   2s
</span></span></code></pre></div><p>More <code>ClusterIssuer</code> configuration options available in the <a href=https://cert-manager.io/docs/configuration/ target=_blank rel=noreferrer>Cert-manager docs</a>.</p><h4 id=configuring-istio-gateway-to-serve-https-traffic class="relative group">Configuring Istio Gateway to serve HTTPS traffic <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#configuring-istio-gateway-to-serve-https-traffic aria-label=Anchor>#</a></span></h4><p>To expose services via HTTPS, it is required to configure a secure Istio Gateway. For this purpose, we will use Cert-manager to issue a certificate for the Istio Ingress Gateway address and provide it to the <code>Gateway</code>.</p><p>Discover the <code>IngressGateway</code> address to use in the certificate:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>export</span> <span class=nv>INGRESS_HOST</span><span class=o>=</span><span class=k>$(</span>kubectl get svc istio-ingressgateway --namespace ingress -o yaml -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span class=k>)</span>
</span></span></code></pre></div><blockquote><p><strong>NOTE:</strong> if running in the cloud and the <code>LoadBalancer</code> service type is bound to a load balancer, then <code>.status.loadBalancer.ingress[0].ip</code> might render an empty result. If a <code>LoadBalancer</code> service has a DNS name assigned to it, use <code>.status.loadBalancer.ingress[0].hostname</code> instead. Alternatively, run <code>kubectl describe svc istio-ingressgateway --namespace ingress</code> and save the publicly exposed address.</p></blockquote><p>The <code>Certificate</code> would look as follows (we&rsquo;ll be using the IP address from the previous step in the <code>ipAddresses</code> field):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: cert-manager.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Certificate
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: gateway-cert
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  secretName: gateway-cert
</span></span></span><span class=line><span class=cl><span class=s>  ipAddresses:
</span></span></span><span class=line><span class=cl><span class=s>  - &#34;${INGRESS_HOST}&#34;
</span></span></span><span class=line><span class=cl><span class=s>  duration: 2160h # 90d
</span></span></span><span class=line><span class=cl><span class=s>  renewBefore: 360h # 15d
</span></span></span><span class=line><span class=cl><span class=s>  subject:
</span></span></span><span class=line><span class=cl><span class=s>    organizations:
</span></span></span><span class=line><span class=cl><span class=s>      - Datastrophic
</span></span></span><span class=line><span class=cl><span class=s>  issuerRef:
</span></span></span><span class=line><span class=cl><span class=s>    name: ca-issuer
</span></span></span><span class=line><span class=cl><span class=s>    kind: ClusterIssuer
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>Verify the <code>Certificate</code> is created:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl get certificate gateway-cert -o wide -n ingress  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME           READY   SECRET         ISSUER      STATUS                                          AGE
</span></span><span class=line><span class=cl>gateway-cert   True    gateway-cert   ca-issuer   Certificate is up to date and has not expired   16s
</span></span></code></pre></div><p>Create a secure Istio <code>Gateway</code> that configures the Ingress proxies to use the certificate created at the previous step:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: networking.istio.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: Gateway
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: ingress-gateway
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    app: istio-ingressgateway
</span></span></span><span class=line><span class=cl><span class=s>	istio: ingressgateway
</span></span></span><span class=line><span class=cl><span class=s>  servers:
</span></span></span><span class=line><span class=cl><span class=s>  - port:
</span></span></span><span class=line><span class=cl><span class=s>      number: 443
</span></span></span><span class=line><span class=cl><span class=s>      name: https-main
</span></span></span><span class=line><span class=cl><span class=s>      protocol: HTTPS
</span></span></span><span class=line><span class=cl><span class=s>    hosts:
</span></span></span><span class=line><span class=cl><span class=s>    - &#34;*&#34;
</span></span></span><span class=line><span class=cl><span class=s>    tls:
</span></span></span><span class=line><span class=cl><span class=s>      mode: SIMPLE
</span></span></span><span class=line><span class=cl><span class=s>      credentialName: gateway-cert
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>Before deploying the <code>Gateway</code>, <code>curl</code> to <code>https://$INGRESS_HOST</code> returns <code>Connection refused</code>. However, after the <code>Gateway</code> was created, the certificate can be verified by running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl --cacert ca.pem -v https://<span class=nv>$INGRESS_HOST</span>
</span></span></code></pre></div><p>Where <code>--cacert ca.pem</code> points to the previously created root CA. It is expected that the above command returns <code>404</code> as there are no <code>VirtualService</code> routes configured yet.</p><h3 id=authorizing-user-requests class="relative group">Authorizing user requests <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#authorizing-user-requests aria-label=Anchor>#</a></span></h3><p>After the TLS ingress is configured, we can now proceed with Istio External Authorization, Dex, and OAuth2 Proxy. As a result, the Istio Ingress Gateway will be using OAuth2 Proxy as an external authorization service which in turn will trigger authorization flow with Dex. Dex configuration for this blog post will serve static users but can be configured to work with supported providers.</p><p>First, let&rsquo;s create a dedicated <code>auth</code>namespace with Istio sidecar injection enabled:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Namespace
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: auth
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    istio-injection: enabled
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h4 id=installing-dex-and-configuring-clients class="relative group">Installing Dex and configuring clients <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#installing-dex-and-configuring-clients aria-label=Anchor>#</a></span></h4><p>Dex will be installed using Helm, and an example Dex configuration can be found <a href=https://github.com/dexidp/dex/blob/master/config.yaml.dist target=_blank rel=noreferrer>here</a>. In the configuration below, the Dex configuration contains a record for an OAuth2 Proxy static client that at this point is not yet installed. It also includes two static users for testing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># bcrypt hash for &#34;password&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PWD_HASH</span><span class=o>=</span><span class=k>$(</span>htpasswd -bnBC <span class=m>10</span> <span class=s2>&#34;&#34;</span> password <span class=p>|</span> tr -d <span class=s1>&#39;:\n&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; dex-values.yaml
</span></span></span><span class=line><span class=cl><span class=s>config:
</span></span></span><span class=line><span class=cl><span class=s>  issuer: &#34;https://${INGRESS_HOST}/dex&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  storage:
</span></span></span><span class=line><span class=cl><span class=s>    type: kubernetes
</span></span></span><span class=line><span class=cl><span class=s>    config:
</span></span></span><span class=line><span class=cl><span class=s>      inCluster: true
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  oauth2:
</span></span></span><span class=line><span class=cl><span class=s>    skipApprovalScreen: true
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  staticClients:
</span></span></span><span class=line><span class=cl><span class=s>  - id: oauth2-proxy
</span></span></span><span class=line><span class=cl><span class=s>    name: OAuth2 Proxy
</span></span></span><span class=line><span class=cl><span class=s>    secret: &#34;LG7jUjNiyVDPJdlarO5Mgz3CxS7kNL/1OZ0spRsL&#34;
</span></span></span><span class=line><span class=cl><span class=s>    redirectURIs:
</span></span></span><span class=line><span class=cl><span class=s>      - &#34;https://${INGRESS_HOST}/oauth2/callback&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Password DB must be enabled in order to specify static users
</span></span></span><span class=line><span class=cl><span class=s>  enablePasswordDB: true
</span></span></span><span class=line><span class=cl><span class=s>  staticPasswords:
</span></span></span><span class=line><span class=cl><span class=s>  - email: &#34;user1@datastrophic.io&#34;
</span></span></span><span class=line><span class=cl><span class=s>    hash: &#34;${PWD_HASH}&#34;
</span></span></span><span class=line><span class=cl><span class=s>  - email: &#34;user2@datastrophic.io&#34;
</span></span></span><span class=line><span class=cl><span class=s>    hash: &#34;${PWD_HASH}&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>Install Dex with the provided configuration:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm repo add dex https://charts.dexidp.io
</span></span><span class=line><span class=cl>helm repo update
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>helm install dex dex/dex <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --version 0.6.3 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --values dex-values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace auth <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --wait
</span></span></code></pre></div><p>Expose Dex at the endpoint&rsquo;s <code>/dex</code> path via a <code>VirtualService</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: networking.istio.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: VirtualService
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s> name: dex
</span></span></span><span class=line><span class=cl><span class=s> namespace: auth
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s> hosts:
</span></span></span><span class=line><span class=cl><span class=s> - &#34;*&#34;
</span></span></span><span class=line><span class=cl><span class=s> gateways:
</span></span></span><span class=line><span class=cl><span class=s> - ingress/ingress-gateway
</span></span></span><span class=line><span class=cl><span class=s> http:
</span></span></span><span class=line><span class=cl><span class=s> - name: &#34;dex&#34;
</span></span></span><span class=line><span class=cl><span class=s>   match:
</span></span></span><span class=line><span class=cl><span class=s>   - uri:
</span></span></span><span class=line><span class=cl><span class=s>       prefix: &#34;/dex&#34;
</span></span></span><span class=line><span class=cl><span class=s>   route:
</span></span></span><span class=line><span class=cl><span class=s>   - destination:
</span></span></span><span class=line><span class=cl><span class=s>       host: dex.auth.svc.cluster.local
</span></span></span><span class=line><span class=cl><span class=s>       port:
</span></span></span><span class=line><span class=cl><span class=s>         number: 5556
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h4 id=installing-oauth2-proxy class="relative group">Installing OAuth2 Proxy <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#installing-oauth2-proxy aria-label=Anchor>#</a></span></h4><p>OAuth2 Proxy has quite a few configuration options described in <a href=https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/oauth_provider#openid-connect-provider target=_blank rel=noreferrer>oauth2-proxy documentation</a><br>and available in the example <a href=https://github.com/oauth2-proxy/oauth2-proxy/blob/master/contrib/local-environment/kubernetes/values.yaml target=_blank rel=noreferrer>values.yaml</a> in GitHub. The majority of the examples set <code>ssl_insecure_skip_verify</code> parameter to <code>true</code> to skip the verification of the OIDC provider endpoint. This is convenient when it is running with a self-signed certificate, however, if the certificate verification is skipped, this means we&rsquo;re ignoring who is authenticating the users. In this setup, a dedicated certificate will be issued for the ingress endpoint running Dex and mounted to the OAuth2 Proxy for validating the certificates against the CA.</p><p>Create a second certificate for the Gateway address but in the <code>auth</code> namespace:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: cert-manager.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Certificate
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: gateway-cert
</span></span></span><span class=line><span class=cl><span class=s>  namespace: auth
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  secretName: gateway-cert
</span></span></span><span class=line><span class=cl><span class=s>  ipAddresses:
</span></span></span><span class=line><span class=cl><span class=s>  - &#34;${INGRESS_HOST}&#34;
</span></span></span><span class=line><span class=cl><span class=s>  duration: 2160h # 90d
</span></span></span><span class=line><span class=cl><span class=s>  renewBefore: 360h # 15d
</span></span></span><span class=line><span class=cl><span class=s>  subject:
</span></span></span><span class=line><span class=cl><span class=s>    organizations:
</span></span></span><span class=line><span class=cl><span class=s>      - Datastrophic
</span></span></span><span class=line><span class=cl><span class=s>  issuerRef:
</span></span></span><span class=line><span class=cl><span class=s>    name: ca-issuer
</span></span></span><span class=line><span class=cl><span class=s>    kind: ClusterIssuer
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>Create the OAuth2 Proxy Helm configuration:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; oauth2-proxy-values.yaml
</span></span></span><span class=line><span class=cl><span class=s>config:
</span></span></span><span class=line><span class=cl><span class=s>  clientID: &#34;oauth2-proxy&#34;
</span></span></span><span class=line><span class=cl><span class=s>  # openssl rand -base64 32 | head -c 40
</span></span></span><span class=line><span class=cl><span class=s>  clientSecret: &#34;LG7jUjNiyVDPJdlarO5Mgz3CxS7kNL/1OZ0spRsL&#34;
</span></span></span><span class=line><span class=cl><span class=s>  # openssl rand -base64 32 | head -c 32 | base64
</span></span></span><span class=line><span class=cl><span class=s>  #cookieSecret: &#34;SXRNTGYzNUFtNi9MTGUvbXJmUnlLdUlYTU00a29ick4=&#34;
</span></span></span><span class=line><span class=cl><span class=s>  configFile: |-
</span></span></span><span class=line><span class=cl><span class=s>    provider = &#34;oidc&#34;
</span></span></span><span class=line><span class=cl><span class=s>    provider_ca_files = &#34;/etc/gateway-cert/ca.crt&#34;
</span></span></span><span class=line><span class=cl><span class=s>    oidc_issuer_url = &#34;https://${INGRESS_HOST}/dex&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>    set_authorization_header = true
</span></span></span><span class=line><span class=cl><span class=s>    set_xauthrequest = true
</span></span></span><span class=line><span class=cl><span class=s>    cookie_samesite = &#34;lax&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>    email_domains = [&#34;*&#34;]
</span></span></span><span class=line><span class=cl><span class=s>    skip_provider_button = true
</span></span></span><span class=line><span class=cl><span class=s>    upstreams = [ &#34;static://200&#34; ]
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>extraVolumes:
</span></span></span><span class=line><span class=cl><span class=s>  - name: gateway-cert
</span></span></span><span class=line><span class=cl><span class=s>    secret:
</span></span></span><span class=line><span class=cl><span class=s>      secretName: gateway-cert
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>extraVolumeMounts:
</span></span></span><span class=line><span class=cl><span class=s>  - mountPath: /etc/gateway-cert/
</span></span></span><span class=line><span class=cl><span class=s>    name: gateway-cert
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>Install OAuth2 Proxy with the provided configuration:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm repo add oauth2-proxy https://oauth2-proxy.github.io/manifests
</span></span><span class=line><span class=cl>helm repo update
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>helm install oauth2-proxy oauth2-proxy/oauth2-proxy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --version 5.0.6 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace auth <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --values oauth2-proxy-values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --wait
</span></span></code></pre></div><p>Expose OAuth2 Proxy at the endpoint&rsquo;s <code>/oauth2</code> path via a <code>VirtualService</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: networking.istio.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: VirtualService
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s> name: oauth2-proxy
</span></span></span><span class=line><span class=cl><span class=s> namespace: auth
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s> hosts:
</span></span></span><span class=line><span class=cl><span class=s> - &#34;*&#34;
</span></span></span><span class=line><span class=cl><span class=s> gateways:
</span></span></span><span class=line><span class=cl><span class=s> - ingress/ingress-gateway
</span></span></span><span class=line><span class=cl><span class=s> http:
</span></span></span><span class=line><span class=cl><span class=s> - name: &#34;oauth2&#34;
</span></span></span><span class=line><span class=cl><span class=s>   match:
</span></span></span><span class=line><span class=cl><span class=s>   - uri:
</span></span></span><span class=line><span class=cl><span class=s>       prefix: &#34;/oauth2&#34;
</span></span></span><span class=line><span class=cl><span class=s>   route:
</span></span></span><span class=line><span class=cl><span class=s>   - destination:
</span></span></span><span class=line><span class=cl><span class=s>       host: oauth2-proxy.auth.svc.cluster.local
</span></span></span><span class=line><span class=cl><span class=s>       port:
</span></span></span><span class=line><span class=cl><span class=s>         number: 5556
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h4 id=configuring-istio-external-authorization class="relative group">Configuring Istio External Authorization <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#configuring-istio-external-authorization aria-label=Anchor>#</a></span></h4><p>Istio External Authorization is a mesh-wide configuration property that is applied to Istiod. In the example below, we register a new external authorization service (OAuth2 Proxy):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; istio-values.yaml
</span></span></span><span class=line><span class=cl><span class=s>meshConfig:
</span></span></span><span class=line><span class=cl><span class=s>  extensionProviders:
</span></span></span><span class=line><span class=cl><span class=s>    - name: oauth2-proxy
</span></span></span><span class=line><span class=cl><span class=s>      envoyExtAuthzHttp:
</span></span></span><span class=line><span class=cl><span class=s>        service: oauth2-proxy.auth.svc.cluster.local
</span></span></span><span class=line><span class=cl><span class=s>        port: 80
</span></span></span><span class=line><span class=cl><span class=s>        includeHeadersInCheck: [&#34;authorization&#34;, &#34;cookie&#34;]
</span></span></span><span class=line><span class=cl><span class=s>        headersToUpstreamOnAllow: [&#34;authorization&#34;, &#34;path&#34;, &#34;x-auth-request-user&#34;, &#34;x-auth-request-email&#34;, &#34;x-auth-request-access-token&#34;]
</span></span></span><span class=line><span class=cl><span class=s>        headersToDownstreamOnDeny: [&#34;content-type&#34;, &#34;set-cookie&#34;]
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>helm upgrade istiod istio/istiod <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace istio-system <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --values istio-values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --wait
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl rollout restart deployment/istiod -n istio-system
</span></span></code></pre></div><p>And to enable the external authorization, it is required to apply the <code>AuthorizationPolicy</code> referencing the above extension provider to the Istio Ingress Gateway:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: security.istio.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: AuthorizationPolicy
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: external-auth
</span></span></span><span class=line><span class=cl><span class=s>  namespace: ingress
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: istio-ingressgateway
</span></span></span><span class=line><span class=cl><span class=s>      istio: ingressgateway
</span></span></span><span class=line><span class=cl><span class=s>  action: CUSTOM
</span></span></span><span class=line><span class=cl><span class=s>  provider:
</span></span></span><span class=line><span class=cl><span class=s>    name: oauth2-proxy
</span></span></span><span class=line><span class=cl><span class=s>  rules:
</span></span></span><span class=line><span class=cl><span class=s>    - to:
</span></span></span><span class=line><span class=cl><span class=s>        - operation:
</span></span></span><span class=line><span class=cl><span class=s>            hosts: [&#34;*&#34;]
</span></span></span><span class=line><span class=cl><span class=s>            notPaths: [&#34;/dex/*&#34;]  # skipping Dex running on the same Gateway to avoid redirect loops
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>Now, everything is ready and all unauthorized requests should be redirected to Dex by OAuth2 Proxy. To verify that, navigate to <a href=https://INGRESS_HOST target=_blank rel=noreferrer><code>https://$INGRESS_HOST</code></a> in your browser. There are two static users <code>user1@datastrophic.io</code> and <code>user2@datastrophic.io</code> with a password: <code>password</code>. As we don&rsquo;t have user-facing applications running yet, you&rsquo;ll be redirected to the root path and get a <code>404</code> which is expected.</p><h3 id=base-kubeflow-installation class="relative group">Base Kubeflow installation <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#base-kubeflow-installation aria-label=Anchor>#</a></span></h3><p>To verify the secure ingress for Kubeflow, let&rsquo;s install several basic components, log in as different users, and use the collaboration feature to share a notebook.</p><p><a href=https://github.com/datastrophic/kubeflow-kustomize target=_blank rel=noreferrer>datastrophic/kubeflow-kustomize</a> repository contains kustomizations for a demo installation of the Kubeflow based on <a href=https://github.com/kubeflow/manifests target=_blank rel=noreferrer>kubeflow/manifests</a> repository. The kustomizations in the repository modify base manifests to make them work with the custom Istio <code>Gateway</code> and OAuth2 Proxy headers. The kustomizations also patch the Central Dashboard <code>VirtualService</code> to add a redirect for <code>/logout</code> path to the OAuth2 Proxy sign out endpoint:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>centraldashboard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gateways</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ingress/ingress-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exact</span><span class=p>:</span><span class=w> </span><span class=l>/logout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>redirect</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>uri</span><span class=p>:</span><span class=w> </span><span class=l>/oauth2/sign_out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rewrite</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>uri</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>centraldashboard.kubeflow.svc.cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>To install the basic components of Kubeflow, clone the repository and from the root directory run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl apply -k kubeflow
</span></span></code></pre></div><p>Once all pods in the Kubeflow namespace are up and running, navigate to <a href=https://INGRESS_HOST target=_blank rel=noreferrer><code>https://$INGRESS_HOST</code></a>. The <code>Gateway</code> should redirect the browser to the Dex login page and, after the login is successful, to the Central Dashboard page. Below, is a quick demo:</p><p><figure><img src=./kubeflow-auth-demo.gif alt="Kubeflow Authentication Demo" class="mx-auto my-0 rounded-md"></figure></p><p>This demonstrates that the external authorization policy works as expected, required headers are set by the authentication workflow, <code>AuthorizationPolicies</code> are applied correctly, and the configuration of Kubeflow components is compatible with the provided authorization stack.</p><h2 id=conclusion class="relative group">Conclusion <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#conclusion aria-label=Anchor>#</a></span></h2><p>Setting up the secure ingress with authentication requires an understanding of all the moving parts
and interactions between them to address this task properly. Treating the authentication stack
independently of the applications that depend on it looks preferable from the cluster management
perspective when multiple applications benefit from the centralized solution.</p><p>The manual installation is pretty involving and error-prone. As there are several systems with non-trivial configuration involved, these steps are great candidates for being automated and installed as
self-contained units of the infrastructure with solutions such as Flux or ArgoCD.</p><hr><h2 id=references class="relative group">References <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line:none !important" href=#references aria-label=Anchor>#</a></span></h2><ol><li>Istio documentation on <a href=https://istio.io/latest/docs/concepts/traffic-management/ target=_blank rel=noreferrer>Traffic Management</a></li><li><a href=https://istio.io/latest/blog/2021/better-external-authz/ target=_blank rel=noreferrer>Better External Authorization</a> blog post from Istio</li><li>Istio documentation on best practices for <a href=https://istio.io/latest/docs/setup/additional-setup/gateway/ target=_blank rel=noreferrer>Installing Gateways</a></li><li><a href=https://www.jetstack.io/blog/istio-oidc/ target=_blank rel=noreferrer>Istio OIDC Authentication</a> blog post from JetStack</li><li><a href=https://homelab.blog/blog/devops/Istio-OIDC-Config/ target=_blank rel=noreferrer>Configuring Istio with OIDC authentication</a> blog post by Justin Gauthier</li></ol></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=flex><picture class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full"><img width=400 height=400 class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full" alt="Anton Kirillov" loading=lazy decoding=async src=https://datastrophic.io/img/author.jpg></picture><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Anton Kirillov</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Technical Leader. Compute and AI Infrastructure</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://www.linkedin.com/in/datastrophic/ target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/datastrophic target=_blank aria-label=Github rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=https://datastrophic.io/kubernetes-homelab-with-proxmox-kubeadm-calico-openebs-and-metallb/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">The Ultimate Kubernetes Homelab Guide: From Zero to Production Cluster On-Premises</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-12-01 00:00:00 +0000 UTC">1 December 2021</time>
</span></span></a></span><span></span></div></div></footer></article></main><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12" id=to-top hidden=true><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">© 2025 datastrophic</p></div><div class="flex flex-row items-center"><div class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher-0 type=button aria-label="appearance switcher"><div class="flex h-12 w-12 items-center justify-center dark:hidden" title="Switch to dark appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden h-12 w-12 items-center justify-center dark:flex" title="Switch to light appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div></div></footer></div></body></html>